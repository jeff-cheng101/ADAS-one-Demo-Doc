# Node.js 專案技術元件盤點報告

> **生成時間**: 2025年1月  
> **專案名稱**: ADAS-one-Demo  
> **分析範圍**: backend/ 目錄下的所有技術元件  
> **資料來源**: 基於實際程式碼檔案分析

---

## 一、核心框架與執行環境

### 1.1 Node.js 執行環境
- **執行環境**: Node.js (CommonJS 模式)
- **模組系統**: `"type": "commonjs"` (依據 `package.json`)
- **HTTP 請求**: 使用 Node.js 18+ 內建的全域 `fetch` API
  - 依據: `backend/services/elkMCPClient.js` 第 12 行註解「使用全域 fetch (Node.js 18+ 內建)」

### 1.2 Web 框架
- **Express.js**: `^5.1.0`
  - 用途: 主要 Web 框架，提供 RESTful API 服務
  - 依據: `backend/index.js` 第 2 行 `const express = require('express')`
  - 配置: 純後端 API 服務架構，無前端渲染功能

### 1.3 中間件
- **CORS**: `^2.8.5` - 跨來源資源共享
  - 配置: 支援純後端模式，允許所有來源（可透過環境變數限制）
  - 依據: `backend/config/security.js` 第 16 行
  
- **Helmet**: `^8.1.0` - HTTP 安全標頭
  - 用途: 設定 Content-Security-Policy 等安全標頭
  - 依據: `backend/index.js` 第 44-54 行

- **express-rate-limit**: `^8.0.1` - API 速率限制
  - 配置: 預設 15 分鐘窗口，最多 100 次請求
  - 依據: `backend/config/security.js` 第 20-23 行

- **express-validator**: `^7.2.1` - 請求驗證
  - 用途: 驗證 API 請求參數
  - 依據: `backend/index.js` 第 6 行

---

## 二、資料儲存層

### 2.1 Elasticsearch (透過 MCP)
- **連接方式**: 透過 Model Context Protocol (MCP) 連接
- **伺服器位址**: `https://10.168.10.250:9200` (預設值)
- **索引模式**: `adasone-cf-logpush-*`
- **認證方式**: API Key 認證
- **最大查詢結果**: 10,000 筆 (可配置)
- **配置檔案**: `backend/config/elkConfig.js`

**關鍵配置**:
- 預設時間範圍: 1 小時
- 最大時間範圍: 24 小時
- 攻擊閾值: 20 (DDoS 攻擊判斷)
- 時間窗口: 10 秒

**查詢功能**:
- 支援自定義時間範圍查詢
- 支援時間分段查詢（處理長時間範圍）
- 支援聚合統計查詢
- 支援 OWASP Top 10 攻擊類型分類

**依據檔案**:
- `backend/config/elkConfig.js` - 完整 ELK 配置
- `backend/services/elkMCPClient.js` - Elasticsearch 查詢客戶端

### 2.2 檔案系統儲存
- **匯出目錄**: `backend/exports/` - 用於暫存匯出的分析報告
- **清理機制**: 自動清理超過 24 小時的檔案
- **依據**: `backend/services/exportService.js`

---

## 三、AI/ML 相關元件

### 3.1 Model Context Protocol (MCP)
- **SDK 版本**: `@modelcontextprotocol/sdk@^1.16.0`
- **協議版本**: `2024-11-05`
- **連接方式**: 
  - **HTTP 模式** (主要): 透過 HTTP/SSE 連接 MCP Server
  - **Proxy 模式**: 使用 `mcp-proxy` 橋接 HTTP 到 stdio
  - **Stdio 模式** (備用): 直接使用 stdio 傳輸

**MCP Server 配置**:
- 伺服器 URL: `http://10.168.10.250:8080` (預設)
- 連接超時: 240,000ms (4 分鐘)
- 重試次數: 3 次
- 協議類型: `proxy` (預設)

**可用工具**:
- `list_indices` - 列出 Elasticsearch 索引
- `get_mappings` - 獲取索引欄位映射
- `search` - 執行 Elasticsearch 查詢 DSL
- `esql` - 執行 ES|QL 查詢
- `get_shards` - 獲取索引分片資訊

**依據檔案**:
- `backend/services/elkMCPClient.js` - 完整的 MCP 客戶端實作
- `backend/config/elkConfig.js` - MCP 連接配置

### 3.2 Google Gemini AI
- **套件版本**: `@google/generative-ai@^0.21.0`
- **預設模型**: `gemini-2.5-flash`
- **支援模型**:
  - `gemini-2.5-pro`
  - `gemini-2.5-flash`
  - `gemini-2.5-flash-lite`
- **配置方式**: 透過環境變數 `GEMINI_API_KEY`
- **用途**: 進行攻擊模式分析和安全事件評估

**依據檔案**:
- `backend/services/aiProviderManager.js` - Gemini 客戶端實作
- `backend/config/security.js` - API Key 配置

### 3.3 Ollama (本地大型語言模型)
- **連接方式**: HTTP API
- **預設 API URL**: `http://localhost:11434`
- **支援功能**:
  - 獲取可用模型列表
  - 生成內容 (非串流模式)
  - 模型資訊查詢
  - 連接健康檢查

**特點**:
- 完全離線運行
- 資料隱私保護
- 無配額限制
- 可自定義模型

**依據檔案**:
- `backend/services/ollamaClient.js` - Ollama 客戶端實作
- `backend/services/aiProviderManager.js` - AI 提供商管理器

### 3.4 AI 提供商管理器
- **支援的提供商**: `gemini`, `ollama`
- **功能**:
  - 統一管理多個 AI 提供商
  - 提供商實例快取
  - 連接測試
  - 配置驗證

**依據檔案**:
- `backend/services/aiProviderManager.js`

---

## 四、監控與日誌系統

### 4.1 ELK Stack 整合
- **Elasticsearch**: 透過 MCP 協議連接
- **資料來源**: Cloudflare Logpush 日誌
- **索引模式**: `adasone-cf-logpush-*`
- **日誌欄位**: 使用 Cloudflare 欄位映射 (`cloudflare-field-mapping.js`)

**分析功能**:
- 攻擊日誌查詢
- IP 活動追蹤
- 安全事件統計
- 趨勢分析

**依據檔案**:
- `backend/services/elkMCPClient.js`
- `backend/config/elkConfig.js`
- `cloudflare-field-mapping.js`

### 4.2 請求日誌
- **記錄方式**: Console 輸出
- **格式**: `{timestamp} - {method} {path}`
- **依據**: `backend/index.js` 第 83-86 行

---

## 五、其他重要元件

### 5.1 安全元件

#### 5.1.1 密碼加密
- **bcrypt**: `^6.0.0`
  - 用途: 密碼雜湊加密
  - 依據: `backend/package.json` 第 16 行

#### 5.1.2 JWT 認證
- **jsonwebtoken**: `^9.0.2`
  - 用途: JSON Web Token 生成與驗證
  - 配置: 透過環境變數 `JWT_SECRET`
  - 依據: `backend/config/security.js` 第 14 行

#### 5.1.3 環境變數管理
- **dotenv**: `^17.2.0`
  - 用途: 載入環境變數
  - 依據: `backend/config/security.js` 第 2 行

### 5.2 HTTP 請求
- **node-fetch**: `^2.7.0` (已安裝但程式碼中主要使用全域 fetch)
  - 用途: HTTP 請求 (備用)
  - 依據: `backend/package.json` 第 24 行
  - 注意: 程式碼中主要使用 Node.js 18+ 內建的 `fetch` API

### 5.3 業務服務

#### 5.3.1 趨勢分析服務
- **檔案**: `backend/services/trendAnalysisService.js`
- **功能**:
  - 時間區間計算 (1h, 6h, 1d, 3d, 7d, 30d)
  - 攻擊趨勢對比分析
  - 流量統計

#### 5.3.2 匯出服務
- **檔案**: `backend/services/exportService.js`
- **功能**:
  - 生成分析報告檔案
  - 自動清理過期檔案 (24 小時)
  - 支援 JSON、CSV 格式匯出

#### 5.3.3 文件推薦服務
- **檔案**: `backend/services/docRecommendationService.js`
- **功能**:
  - 根據意圖推薦 Cloudflare 文件
  - 白名單映射表機制
  - 支援國別封鎖、序列規則等場景

### 5.4 配置管理

#### 5.4.1 ELK 配置
- **檔案**: `backend/config/elkConfig.js`
- **內容**:
  - MCP 連接配置
  - Elasticsearch 連接配置
  - OWASP Top 10 參考連結
  - 攻擊路徑分類配置
  - 攻擊類型識別函數

#### 5.4.2 安全配置
- **檔案**: `backend/config/security.js`
- **內容**:
  - API Keys 管理
  - JWT 配置
  - CORS 配置
  - 速率限制配置
  - 配置驗證函數

---

## 六、元件整合分析

### 6.1 資料流程

```
Cloudflare Logpush → Elasticsearch → MCP Server → elkMCPClient → Express API
                                                                    ↓
                                                          AI Provider Manager
                                                                    ↓
                                                          Gemini / Ollama
                                                                    ↓
                                                          Trend Analysis Service
                                                                    ↓
                                                          Export Service
```

### 6.2 核心整合點

#### 6.2.1 MCP 與 Elasticsearch
- **連接方式**: 透過 MCP 協議封裝 Elasticsearch 查詢
- **優點**: 統一的協議介面，支援多種傳輸方式 (HTTP/SSE/stdio)
- **容錯機制**: 自動重連、新實例回退

#### 6.2.2 AI 分析流程
1. **資料查詢**: 透過 `elkMCPClient` 查詢 Elasticsearch
2. **AI 處理**: 使用 `AIProviderManager` 選擇 AI 提供商 (Gemini/Ollama)
3. **結果分析**: 結合 OWASP Top 10 分類進行攻擊類型識別
4. **趨勢分析**: 使用 `TrendAnalysisService` 進行時間區間對比
5. **結果匯出**: 透過 `ExportService` 生成報告

#### 6.2.3 安全層整合
- **請求驗證**: `express-validator` 驗證輸入
- **速率限制**: `express-rate-limit` 防止濫用
- **安全標頭**: `helmet` 設定 HTTP 安全標頭
- **CORS**: 可配置的跨來源策略

### 6.3 依賴關係圖

```
Express Application
├── Security Middleware
│   ├── Helmet (安全標頭)
│   ├── CORS (跨來源)
│   ├── Rate Limiter (速率限制)
│   └── Validator (請求驗證)
│
├── ELK Integration
│   ├── elkMCPClient (MCP 客戶端)
│   └── Elasticsearch (透過 MCP)
│
├── AI Services
│   ├── AIProviderManager (管理器)
│   ├── GeminiClient (Google AI)
│   └── OllamaClient (本地 AI)
│
├── Business Services
│   ├── TrendAnalysisService (趨勢分析)
│   ├── ExportService (匯出服務)
│   └── DocRecommendationService (文件推薦)
│
└── Configuration
    ├── elkConfig.js (ELK 配置)
    └── security.js (安全配置)
```

---

## 七、建議與注意事項

### 7.1 安全建議

#### 7.1.1 環境變數配置
- ⚠️ **重要**: 生產環境必須設定以下環境變數：
  - `GEMINI_API_KEY` - Gemini AI API 金鑰
  - `APP_SECRET` - 應用程式密鑰 (非預設值)
  - `JWT_SECRET` - JWT 簽章密鑰 (非預設值)
  - `ELK_API_KEY` - Elasticsearch API 金鑰
  - `ELK_MCP_SERVER_URL` - MCP 伺服器位址

#### 7.1.2 CORS 配置
- 目前預設允許所有來源 (`*`)
- **建議**: 生產環境應透過 `CORS_ORIGINS` 環境變數限制允許的來源

#### 7.1.3 API 金鑰安全
- 所有 API 金鑰應透過環境變數管理
- 不應將 API 金鑰寫入程式碼或版本控制系統

### 7.2 效能建議

#### 7.2.1 Elasticsearch 查詢
- 長時間範圍查詢 (>2 小時) 建議使用分段查詢
- 查詢結果限制為 10,000 筆，避免記憶體溢出
- 已實作自動分段查詢機制

#### 7.2.2 MCP 連接
- 使用單例模式管理連接，避免重複建立
- 已實作連接池和自動重連機制
- 超時時間設定為 4 分鐘，適應大資料量查詢

#### 7.2.3 AI 回應時間
- Gemini: 通常 < 5 秒
- Ollama: 依模型大小而定，可能需要更長時間
- 已實作回應時間監控

### 7.3 架構建議

#### 7.3.1 資料庫考量
- 目前專案**沒有使用傳統關聯式資料庫** (如 PostgreSQL、MySQL)
- 所有資料儲存依賴 Elasticsearch
- 如需持久化儲存，可考慮：
  - MongoDB (文件資料庫)
  - PostgreSQL (關聯式資料庫)
  - Redis (快取層)

#### 7.3.2 快取機制
- 目前**沒有實作快取層**
- **建議**: 考慮使用 Redis 快取頻繁查詢的結果
- 可快取的項目：
  - AI 分析結果
  - 趨勢統計資料
  - 文件推薦列表

#### 7.3.3 監控與告警
- 目前只有 Console 日誌
- **建議**: 整合日誌收集系統 (如 ELK Stack 的 Logstash/Kibana)
- 可考慮整合：
  - Prometheus (指標收集)
  - Grafana (視覺化)
  - Sentry (錯誤追蹤)

### 7.4 版本相容性

#### 7.4.1 Node.js 版本
- 專案使用 Node.js 18+ 內建的 `fetch` API
- **最低版本要求**: Node.js 18.0.0
- **建議版本**: Node.js 20.x LTS 或更高

#### 7.4.2 Express 版本
- 使用 Express 5.1.0 (較新版本)
- 注意 API 變更和相容性

### 7.5 已知限制

#### 7.5.1 資料儲存
- 所有資料依賴外部 Elasticsearch 服務
- 沒有本地備份機制
- 建議實作資料匯出和備份功能

#### 7.5.2 AI 服務
- Gemini 需要網路連接和 API 配額
- Ollama 需要本地部署和硬體資源
- 兩者都不可用時，相關功能會失敗

#### 7.5.3 MCP 連接
- 依賴外部 MCP Server 服務
- 連接失敗時會自動重試，但可能需要手動介入

---

## 八、技術棧總結

### 8.1 技術分類表

| 類別 | 技術元件 | 版本 | 用途 |
|------|---------|------|------|
| **Web 框架** | Express | 5.1.0 | RESTful API 服務 |
| **安全** | Helmet | 8.1.0 | HTTP 安全標頭 |
| **安全** | express-rate-limit | 8.0.1 | API 速率限制 |
| **安全** | express-validator | 7.2.1 | 請求驗證 |
| **安全** | bcrypt | 6.0.0 | 密碼加密 |
| **安全** | jsonwebtoken | 9.0.2 | JWT 認證 |
| **資料庫** | Elasticsearch | - | 日誌儲存與查詢 |
| **協議** | MCP SDK | 1.16.0 | Model Context Protocol |
| **AI** | Google Gemini | 0.21.0 | 雲端 AI 服務 |
| **AI** | Ollama | - | 本地 AI 服務 |
| **工具** | dotenv | 17.2.0 | 環境變數管理 |
| **工具** | node-fetch | 2.7.0 | HTTP 請求 (備用) |
| **工具** | CORS | 2.8.5 | 跨來源資源共享 |

### 8.2 架構特點

1. **純後端架構**: 無前端渲染，專注於 API 服務
2. **AI 整合**: 支援多種 AI 提供商 (Gemini/Ollama)
3. **MCP 協議**: 使用標準化的 MCP 協議連接 Elasticsearch
4. **安全優先**: 多層安全機制 (Helmet, Rate Limiting, Validation)
5. **可擴展性**: 服務化架構，易於擴展新功能

### 8.3 專案類型

- **專案性質**: 純後端 API 服務
- **主要功能**: DDoS 攻擊分析與 AI 智能評估
- **資料來源**: Cloudflare Logpush 日誌
- **目標用戶**: 安全分析師、系統管理員

---

## 附錄：環境變數清單

### 必需環境變數
```bash
GEMINI_API_KEY=your_gemini_api_key
```

### 可選環境變數
```bash
# 應用程式配置
APP_SECRET=your_app_secret
JWT_SECRET=your_jwt_secret
CORS_ORIGINS=*  # 或指定來源，用逗號分隔

# ELK 配置
ELK_HOST=https://10.168.10.250:9200
ELK_INDEX=adasone-cf-logpush-*
ELK_API_KEY=your_elk_api_key
ELK_MCP_SERVER_URL=http://10.168.10.250:8080
ELK_MCP_PROTOCOL=proxy  # 或 http, stdio
ELK_MCP_TIMEOUT=240000
ELK_MAX_RESULTS=10000

# 速率限制
RATE_LIMIT_WINDOW=15  # 分鐘
RATE_LIMIT_MAX_REQUESTS=100

# Gemini 模型
GEMINI_MODEL=gemini-2.5-flash
```

---

**報告生成依據**:
- `backend/package.json` - 依賴套件清單
- `backend/config/elkConfig.js` - ELK 配置
- `backend/config/security.js` - 安全配置
- `backend/services/elkMCPClient.js` - MCP 客戶端
- `backend/services/ollamaClient.js` - Ollama 客戶端
- `backend/services/aiProviderManager.js` - AI 管理器
- `backend/services/trendAnalysisService.js` - 趨勢分析
- `backend/services/exportService.js` - 匯出服務
- `backend/index.js` - 主應用程式
- `README.md` - 專案文檔

**注意事項**: 本報告基於實際程式碼檔案分析，所有資訊皆有明確的程式碼依據。未在程式碼中發現的元件（如 MongoDB、PostgreSQL、Redis 等）未列入報告中。

